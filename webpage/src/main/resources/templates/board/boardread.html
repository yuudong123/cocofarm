<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{fragments/head :: headFragment}"></th:block>
    <link rel="stylesheet" href="/css/board/boardread.css" />
  </head>
  <body>
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
    <main>
      <div class="container">
        <div id="btnBox">
          <button id="btnList" class="btn">목록으로</button>
          <th:block th:if="${userinfo != null && userinfo.member_type_cd == 101}">
            <button id="btnModify" class="btn blue">수정</button>
            <button id="btnDelete" class="btn red">삭제</button>
          </th:block>
        </div>
        <section class="z-depth-1">
          <h5 th:text="${boardvo.title}"></h5>
          <div id="titlebox">
            <span th:text="${#dates.format(boardvo.regdate,'yyyy/MM/dd HH:mm:ss')}"></span>
            <small th:if="${boardvo.regdate != boardvo.upddate}" style="color: #aaa" th:text="${#dates.format(boardvo.upddate,'yyyy/MM/dd HH:mm:ss')}+' 에 수정됨'"></small>
          </div>
          <div id="hr"></div>
          <img id="mainimage" class="responsive-img" th:src="'/images/'+${boardvo.mainimage}" alt="메인 이미지" />
          <p th:text="${boardvo.content}"></p>
        </section>
        <section class="z-depth-1">
          <h6>댓글</h6>
          <div th:if="${userinfo!=null}" data-method="write" id="replyForm" data-isopen="false" class="z-depth-1">
            <textarea id="replyContent" class="materialize-textarea" type="text" placeholder="여기에 댓글 입력"></textarea>
          </div>
          <button th:if="${userinfo!=null}" id="btnReplyConfirm" class="btn">확인</button>
          <button th:if="${userinfo!=null}" id="btnReply" class="btn">댓글 쓰기</button>
          <div id="replyList">
            <table th:each="reply : ${replylist}" th:if="${replylist.size != 0}">
              <thead>
                <tr>
                  <th th:text="${reply.nickname}"></th>
                  <th th:text="${#dates.format(reply.regdate,'yyyy/MM/dd HH:mm:ss')}"></th>
                </tr>
              </thead>
              <tbody>
                <td><span class="reply" th:data-no="${reply.reply_no}" th:text="${reply.content}"></span></td>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
    <th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script th:inline="javascript">
    const btnList = document.querySelector("#btnList");
    const btnModify = document.querySelector("#btnModify");
    const btnDelete = document.querySelector("#btnDelete");
    const btnReply = document.querySelector("#btnReply");
    const btnReplyConfirm = document.querySelector("#btnReplyConfirm");
    const replyForm = document.querySelector("#replyForm");
    const replyModifyForm = document.querySelector("#replyModifyForm");
    const replyList = document.querySelector("#replyList");
    const board_no = /*[[${boardvo.board_no}]]*/ "";
    const replyContent = document.querySelector("#replyContent");
    let modReplyNo = 0;
    let modReplyContent = "";

    onload = loadReply();

    btnList.addEventListener("click", () => {
      location.href = location.href.split("/").slice(0, 5).join("/");
    });
    if (btnModify != null) {
      btnModify.addEventListener("click", () => {
        if (confirm("관리자 페이지로 이동하시겠습니까?")) {
          location.href = location.href.split("/").slice(0, 3).join("/") + "/admin/board/" + board_no + "/modify";
        }
      });
    }
    if (btnDelete != null) {
      btnDelete.addEventListener("click", () => {
        if (confirm("삭제 후 되돌릴 수 없습니다. 정말 삭제하시겠습니까?")) {
          fetchJSON("/" + board_no + "/delete", null, (data) => {
            if (data == 1) {
              alert("삭제되었습니다.");
              history.back();
            } else {
              M.toast({ html: "삭제에 실패했습니다..." });
            }
          });
        }
      });
    }
    if (btnReply != null) {
      btnReply.addEventListener("click", () => {
        toggleReplyBtn();
        replyForm.dataset.method = "write";
        replyContent.textContent = "";
      });
    }
    if (btnReplyConfirm != null) {
      btnReplyConfirm.addEventListener("click", () => {
        if (replyContent.value == "") {
          M.toast({ html: "댓글 내용을 입력해주세요.." });
          return;
        }
        let content = replyContent.value;
        let mapping = "";
        let data = {};
        let msg = "";
        if (replyForm.dataset.method == "write") {
          mapping = "/reply/write";
          data = { content: content, board_no: board_no };
          msg = "댓글 등록";
        } else if (replyForm.dataset.method == "modify") {
          mapping = "/reply/modify";
          data = { content: content, reply_no: modReplyNo };
          msg = "수정";
        }
        fetchTEXT(mapping, data, (data) => {
          if (data == 1) {
            replyContent.value = "";
            toggleReplyBtn();
            loadReply();
            M.toast({ html: msg + " 완료!" });
          } else {
            M.toast({ html: msg + "에 실패했습니다." });
          }
        });
      });
    }
    function modifyReply(reply_no, content) {
      modReplyNo = reply_no;
      modReplyContent = content;
      replyForm.dataset.method = "modify";
      replyContent.textContent = modReplyContent;
      toggleReplyBtn();
    }

    function deleteReply(reply_no) {
      if (confirm("삭제 후 되돌릴 수 없습니다. 삭제하시겠습니까?")) {
        fetchTEXT("/reply/delete", { reply_no: reply_no }, (data) => {
          if (data == 1) {
            loadReply();
            M.toast({ html: "삭제되었습니다." });
          }
        });
      }
    }

    function loadReply() {
      replyList.innerHTML = "";
      fetchJSON("/reply/getlist", { board_no: board_no }, (data) => {
        if (data.length != 0) {
          data.forEach((item) => {
            replyList.innerHTML += item;
          });
        } else {
          replyList.innerHTML = "<p class='grey-text'>댓글이 없습니다.</p>";
        }
      });
    }

    function toggleReplyBtn() {
      if (replyForm.dataset.isopen == "false") {
        replyForm.style.display = "block";
        replyForm.dataset.isopen = "true";
        btnReplyConfirm.style.display = "block";
        btnReply.classList.add("red");
        btnReply.innerHTML = "취소";
      } else {
        replyForm.style.display = "none";
        replyForm.dataset.isopen = "false";
        btnReplyConfirm.style.display = "none";
        btnReply.classList.remove("red");
        btnReply.innerHTML = "댓글 쓰기";
      }
    }
  </script>
</html>
