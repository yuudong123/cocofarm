<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{fragments/head :: headFragment}"></th:block>
    <link rel="stylesheet" href="/css/product/orderpayresult.css" />
  </head>
  <body>
    <!-- 주문 상세 보여주는 html임. url은 order/orderdetail-->
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
    <main>
      <div class="container">
        <!-- 결제완료 주문목록 창 -->
        <div class="order_header">
          <h3 class="order_payment"><span class="blind">주문결제내역</span></h3>
          <!-- <form> -->
          <div class="order_content">
            <div class="order_cont" th:each="dto:${list}">
              <div>
                <span
                  th:text="${#dates.format(dto.orderdate, 'yyyy-MM-dd')}"
                ></span>
                <span>결제</span>
              </div>
              <div th:text="${dto.price}"></div>

              <div class="order_cont" th:each="vo:${dto.orderproduct_list}">
                <div
                  id="order_status_cd"
                  th:data-order-status-cd="${vo.order_status_cd}"
                  th:data-orderproduct-id="${vo.orderproduct_id}"
                >
                  <div th:text="${vo.value}"></div>
                  <div>
                    <img
                      th:src="'/images/'+${vo.filename}"
                      style="width: 200px"
                    />
                  </div>
                  <div th:text="${vo.name}"></div>
                  <div th:text="${vo.price}"></div>
                  <div th:text="${vo.amount}"></div>
                  <div id="button-list" th:switch="${vo.order_status_cd}">
                    <ul th:case="301">
                      <button
                        class="button_deliberyinfo"
                        th:onclick="deliberyinfo([[${dto.order_id}]])"
                      >
                        배송조회
                      </button>
                      <button
                        class="button_cancel"
                        th:onclick="cancel([[${dto.order_id}]],[[${vo.order_status_cd}]],[[${vo.orderproduct_id}]])"
                      >
                        주문 취소
                      </button>
                    </ul>
                    <ul th:case="302">
                      <button
                        class="button_deliberyinfo"
                        th:onclick="deliberyinfo([[${dto.order_id}]])"
                      >
                        배송조회
                      </button>
                      <button
                        class="button_buyconfirm"
                        th:onclick="buyconfirm([[${dto.order_id}]],[[${vo.order_status_cd}]],[[${vo.orderproduct_id}]])"
                      >
                        구매확정
                      </button>
                    </ul>
                    <ul th:case="303">
                      <button
                        class="button_buyconfirm"
                        th:onclick="buyconfirm([[${dto.order_id}]],[[${vo.order_status_cd}]],[[${vo.orderproduct_id}]])"
                      >
                        구매확정
                      </button>
                      <button
                        class="button_changeapply"
                        th:onclick="change([[${dto.order_id}]],[[${vo.order_status_cd}]],[[${vo.orderproduct_id}]]
                        ,[[${vo.name}]],[[${vo.filename}]],[[${vo.amount}]])"
                      >
                        교환신청
                      </button>
                      <button
                        class="button_refundapply"
                        th:onclick="refund([[${dto.order_id}]],[[${vo.order_status_cd}]],[[${vo.orderproduct_id}]]
                        ,[[${vo.name}]],[[${vo.filename}]],[[${vo.amount}]])"
                      >
                        환불신청
                      </button>
                    </ul>
                    <ul th:case="304">
                      <button
                        class="button_deliberyinfo"
                        th:onclick="deliberyinfo([[${dto.order_id}]])"
                      >
                        배송조회
                      </button>
                    </ul>
                    <ul th:case="305">
                      <button
                        class="button_deliberyinfo"
                        th:onclick="deliberyinfo([[${dto.order_id}]])"
                      >
                        배송조회
                      </button>
                    </ul>
                    <ul th:case="310">
                      <button
                        class="button_deliberyinfo"
                        th:onclick="deliberyinfo([[${dto.order_id}]])"
                      >
                        배송조회
                      </button>
                      <button
                        class="button_reviewwrite"
                        th:onclick="reviewwrite([[${vo.orderproduct_id}]])"
                      >
                        리뷰쓰기
                      </button>
                    </ul>
                    <ul th:case="*"></ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- </div> -->
          </div>
          <!-- </form> -->
        </div>
      </div>
    </main>
    <th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>
    <script src="/js/cocofarm.js"></script>

    <!-- Modal Structure 배송조회 모달-->
    <div id="deliberymodal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4 class="modal-title">Modal Header</h4>
        <div id="deliberycontent"></div>
      </div>
      <div class="modal-footer">
        <button class="btncancel btn modal-close">확인</button>
      </div>
    </div>

    <!-- Modal Structure 교환신청 모달-->
    <div id="changemodal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4 class="modal-title">Modal Header</h4>
        <div id="changecontent"></div>
      </div>
      <div class="modal-footer">
        <button class="btnconfirm btn red">신청하기</button>

        <button class="btncancel btn modal-close">취소</button>
      </div>
    </div>

    <!-- Modal Structure 환불신청 모달-->
    <div id="refundmodal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4 class="modal-title">Modal Header</h4>
        <div id="refundcontent"></div>
      </div>
      <div class="modal-footer">
        <button class="btnconfirm btn red">신청하기</button>

        <button class="btncancel btn modal-close">취소</button>
      </div>
    </div>

    <!-- Modal Structure 리뷰쓰기 모달 이대로 쓰기-->
    <div id="reviewmodal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4 class="modal-title">Modal Header</h4>
        <div id="reviewcontent"></div>
      </div>
      <div class="modal-footer" id="reviewfooter">
        <button class="btnconfirm btn red">글 올리기</button>

        <button class="btncancel btn modal-close">취소</button>
      </div>
    </div>
  </body>
  <script>
    let buttonDeliberyinfo = document.querySelectorAll(".button_deliberyinfo");
    let buttonCancel = document.querySelectorAll(".button_cancel");
    let buttonBuyconfirm = document.querySelectorAll(".button_buyconfirm");
    let buttonRefundapply = document.querySelectorAll(".button_refundapply");
    let buttonReviewWrite = document.querySelectorAll(".button_reviewwrite");

    const deliberyModal = M.Modal.init(
      document.querySelector("#deliberymodal"),
      {}
    );
    const changeModal = M.Modal.init(
      document.querySelector("#changemodal"),
      {}
    );
    const refundModal = M.Modal.init(
      document.querySelector("#refundmodal"),
      {}
    );
    const reviewModal = M.Modal.init(
      document.querySelector("#reviewmodal"),
      {}
    );

    //배송조회 확인
    function deliberyinfo(order_id) {
      const data = {
        order_id: order_id,
      };
      sendServerData(
        "POST",
        "/order/deliberystatus",
        "application/json",
        JSON.stringify(data),
        function (data) {
          let title = document.querySelector("#deliberymodal .modal-title");
          title.innerText = "배송정보";
          let content = document.querySelector("#deliberycontent");
          content.innerHTML = data;
        }
      );
      deliberyModal.open();
    }
    //-----------------------------------------------------------------

    //주문 취소 확인
    function cancel(order_id, order_status_cd, orderproduct_id) {
      if (confirm("주문 취소를 원하시면 확인을 눌러주세요. ")) {
        const data = {
          orderproduct_id: orderproduct_id,
          order_status_cd: 300,
          order_id: order_id,
        };
        console.log(data);
        sendServerData(
          "POST",
          "update",
          "application/json",
          JSON.stringify(data),
          function (data) {
            //data = JSON.parse(data);
            if ((data.status = "OK")) {
              //
              alert("주문 취소 처리 되었습니다.");
              location.reload();
            } else {
              alert("삭제하지 못했습니다.");
            }
          }
        );
      }
    }
    //-----------------------------------------------------------------

    //교환 환불 확인
    function change(
      order_id,
      order_status_cd,
      orderproduct_id,
      name,
      filename,
      amount
    ) {
      const data = {
        orderproduct_id: orderproduct_id,
        name: name,
        filename: filename,
        amount: amount,
      };
      console.log(data);
      sendServerData(
        "POST",
        "/order/changeandrefundpage",
        "application/json",
        JSON.stringify(data),
        function (data) {
          let title = document.querySelector("#changemodal .modal-title");
          let content = document.querySelector("#changecontent");
          title.innerText = "교환신청 작성";
          content.innerHTML = data;

          let modalButton = document.querySelector(".btnconfirm");
          if (modalButton) {
            modalButton.onclick = function () {
              let form = document.querySelector("#applicationForm");
              let reasonInput = document.querySelector("#reasonInput");
              const isButtonSelected = applicationForm.querySelector(
                'input[name="changeandrefund"]:checked'
              );
              const isReasonProvided = reasonInput.value.trim().length > 0;
              if (isButtonSelected || isReasonProvided) {
                if (confirm("신청하시겠습니까?")) {
                  const data = {
                    orderproduct_id: orderproduct_id,
                    order_status_cd: 304,
                    order_id: order_id,
                  };
                  sendServerData(
                    "POST",
                    "update",
                    "application/json",
                    JSON.stringify(data),
                    function (data) {
                      if ((data.status = "OK")) {
                        alert("교환및환불 신청이  처리 되었습니다.");
                        changeModal.close();
                        location.reload();
                      } else {
                        alert("삭제하지 못했습니다.");
                      }
                    }
                  );
                }
              } else {
                alert("버튼을 선택하거나 상세사유를 입력해주세요.");
              }
            };
          }

          changeModal.open();
        }
      );
    }

    //----------------------------------------------------------------
    function refund(order_id, order_status_cd, orderproduct_id) {}

    //리뷰
    function reviewwrite(orderproduct_id) {
      const data = {
        orderproduct_id: orderproduct_id,
      };
      sendServerData(
        "POST",
        "/order/reviewwritepage",
        "application/json",
        JSON.stringify(data),
        function (data) {
          let content = document.querySelector("#reviewcontent");
          let title = document.querySelector("#reviewmodal .modal-title");
          title.innerText = "리뷰쓰기";
          content.innerHTML = data;
        }
      );

      let modalButton = document.querySelector("#reviewmodal .btnconfirm");
      if (modalButton) {
        modalButton.innerText = "글 올리기";

        modalButton.onclick = function () {
          let form = document.querySelector("#reviewForm");
          const data = {
            orderproduct_id: form.orderproduct_id.value,
            product_id: form.product_id.value,
            title: form.title.value,
            content: form.content.value,
          };
          sendServerData(
            "POST",
            "/order/reviewsave",
            "application/json",
            JSON.stringify(data),
            function (data) {
              let content = document.querySelector("#reviewcontent");
              let title = document.querySelector("#reviewmodal .modal-title");
              title.innerText = "리뷰쓰기완료";
              content.innerHTML = data;
              let reviewfooter = document.querySelector("#reviewfooter");
              reviewfooter.innerHTML =
                "<button class='btn modal-close'>확인</button>";
            }
          );
        };
        reviewModal.open();
      }
    }

    //구매확정 확인
    function buyconfirm(order_id, order_status_cd, orderproduct_id) {
      if (confirm("구매확정을 원하시면 확인을 눌러주세요. ")) {
        const data = {
          orderproduct_id: orderproduct_id,
          order_status_cd: 310,
          order_id: order_id,
        };
        console.log(data);
        sendServerData(
          "POST",
          "update",
          "application/json",
          JSON.stringify(data),
          function (data) {
            //data = JSON.parse(data);
            if ((data.status = "OK")) {
              //
              alert("구매확정 처리 되었습니다.");
              location.reload();
            } else {
              alert("처리하지 못했습니다.");
            }
          }
        );
      }
    }
    //-----------------------------------------------------------------
    //303에서 환불신청 버튼 눌렀을때
    // 환불 신청 모달 관련 코드

    function openRefundRequestModal(data) {
      let content = document.querySelector("#modal-content");
      let title = document.querySelector("#modal-title");
      title.innerText = "환불신청 작성";
      content.innerHTML = data;

      let modalInstance = M.Modal.getInstance(
        document.querySelector("#reviewmodal")
      );
      let modalButton = document.querySelector("#confirm");
      let modalButton_cancel = document.querySelector(".btn1");

      // 신청하기 버튼 클릭 이벤트 처리
      const modalButtonClickHandler = () => {
        let form = document.querySelector("#applicationForm");
        let reasonInput = document.querySelector("#reasonInput");
        const isButtonSelected = applicationForm.querySelector(
          'input[name="changeandrefund"]:checked'
        );
        const isReasonProvided = reasonInput.value.trim().length > 0;
        if (isButtonSelected || isReasonProvided) {
          confirm("신청하시겠습니까?");
          alert("교환및환불 신청이 완료되었습니다.");
          modalInstance.close();
        } else {
          alert("버튼을 선택하거나 상세사유를 입력해주세요.");
        }
      };

      modalButton.innerText = "신청하기";
      modalButton.removeEventListener("click", modalButtonClickHandler);
      modalButton.addEventListener("click", modalButtonClickHandler);

      modalButton_cancel.innerText = "취소";
      modalInstance.open();
    }

    // 교환신청 버튼 클릭 이벤트 처리
    buttonRefundapply.forEach((button) => {
      button.addEventListener("click", (e) => {
        // let orderproduct_id = e.target.getAttribute("data-orderproduct-id");
        //
        const data = {
          orderproduct_id: orderproduct_id,
          name: name,
          filename: filename,
          amount: amount,
        };
        sendServerData(
          "POST",
          "/order/changeandrefundpage",
          "application/json",
          JSON.stringify(data),
          function (data) {
            openChangeRequestModal(data);
          }
        );
      });
    });

    //310에서 리뷰버튼 눌렀을때
    //  buttonReviewWrite.forEach((button) => {
    //   button.addEventListener("click", (e) => {
    // let orderproduct_id = e.target.getAttribute("data-orderproduct-id");

    //     let modalButton = document.querySelector("#btnconfirm");
    //     modalButton.innerText = "글 올리기";

    //     modalButton.addEventListener("click", () => {
    //       let form = document.querySelector("#reviewForm");
    //       const data = {
    //         orderproduct_id: form.orderproduct_id.value,
    //         product_id: form.product_id.value,
    //         title: form.title.value,
    //         content: form.content.value,
    //       };
    //       sendServerData(
    //         "POST",
    //         "/order/reviewsave",
    //         "application/json",
    //         JSON.stringify(data),
    //         function (data) {
    //           let content = document.querySelector("#modal-content");
    //           let title = document.querySelector("#modal-title");
    //           title.innerText = "리뷰쓰기완료";
    //           content.innerHTML = data;
    //         }
    //       );
    //     });
    //     modalInstance.open();
    //   });
    // });

    //303 배송완료에서 310구매 확정으로 변경
    buttonBuyconfirm.forEach((button) => {
      // let orderproduct_id = button.getAttribute("data-orderproduct-id");
      // let order_status_cd = button.getAttribute("data-order-status-cd");
      // let order_id = button.getAttribute("data-order-id");
      button.addEventListener("click", () => {});
    });

    // buttonCancel.forEach((button) => {
    //   let orderproduct_id = button.getAttribute("data-orderproduct_id");
    //   button.addEventListener("click", () => {
    //     const data = {
    //       orderproduct_id: orderproduct_id,
    //     };
    //     sendServerData(
    //       "POST",
    //       "/order/payresult",
    //       "application/json",
    //       JSON.stringify(data),
    //       function (data) {
    //         data = JSON.parse(data);
    //         if ((data.status = "OK")) {
    //           if (confirm("주문 취소를 원하시면 취소를 눌러주세요. ")) {
    //             alert("주문 취소 처리 되었습니다.");
    //             location.reload();
    //           } else {
    //             alert("삭제하지 못했습니다.");
    //           }
    //         }
    //       }
    //     );
    //   });
    // });
  </script>
</html>
