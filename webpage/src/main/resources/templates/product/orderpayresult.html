<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{fragments/head :: headFragment}"></th:block>
    <link rel="stylesheet" href="/css/product/orderpayresult.css" />
  </head>
  <body>
    <!-- 주문 상세 보여주는 html임. url은 order/orderdetail-->
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
    <main>
      <div class="container">
        <!-- 결제완료 주문목록 창 -->
        <div class="order_header">
          <h3 class="order_payment"><span class="blind">주문결제내역</span></h3>
          <!-- <form> -->
          <div class="order_content">
            <div class="order_cont" th:each="dto:${list}">
              <div>
                <span
                  th:text="${#dates.format(dto.orderdate, 'yyyy-MM-dd')}"
                ></span>
                <span>결제</span>
              </div>
              <div th:text="${dto.price}"></div>

              <div class="order_cont" th:each="vo:${dto.orderproduct_list}">
                <div
                  id="order_status_cd"
                  th:data-order-status-cd="${vo.order_status_cd}"
                  th:data-orderproduct-id="${vo.orderproduct_id}"
                >
                  <div th:text="${vo.value}"></div>
                  <div>
                    <img
                      th:src="'/images/'+${vo.filename}"
                      style="width: 200px"
                    />
                  </div>
                  <div th:text="${vo.name}"></div>
                  <div th:text="${vo.price}"></div>
                  <div th:text="${vo.amount}"></div>
                  <div id="button-list" th:switch="${vo.order_status_cd}">
                    <ul th:case="301">
                      <button
                        class="button_deliberyinfo"
                        th:data-orderproduct-id="${vo.orderproduct_id}"
                        th:data-order-status-cd="${vo.order_status_cd}"
                        th:data-order-id="${dto.order_id}"
                      >
                        배송조회
                      </button>
                      <button class="button_cancel">주문 취소</button>
                    </ul>
                    <ul th:case="302">
                      <button class="button_deliberyinfo">배송조회</button>
                      <button
                        class="button_buyconfirm"
                        th:data-orderproduct-id="${vo.orderproduct_id}"
                        th:data-order-status-cd="${vo.order_status_cd}"
                        th:data-order-id="${dto.order_id}"
                      >
                        구매확정
                      </button>
                    </ul>
                    <ul th:case="303">
                      <button
                        class="button_buyconfirm"
                        th:data-orderproduct-id="${vo.orderproduct_id}"
                        th:data-order-status-cd="${vo.order_status_cd}"
                        th:data-order-id="${dto.order_id}"
                      >
                        구매확정
                      </button>
                      <button class="button_changeapply">교환신청</button>
                      <button class="button_refundapply">환불신청</button>
                    </ul>
                    <ul th:case="304">
                      <button class="button_deliberyinfo">배송조회</button>
                    </ul>
                    <ul th:case="305">
                      <button class="button_deliberyinfo">배송조회</button>
                    </ul>
                    <ul th:case="310">
                      <button class="button_deliberyinfo">배송조회</button>
                      <button class="button_reviewwrite">리뷰쓰기</button>
                    </ul>
                    <ul th:case="*"></ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- </div> -->
          </div>
          <!-- </form> -->
        </div>
      </div>
    </main>
    <th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>
    <script src="/js/cocofarm.js"></script>
  </body>
  <script>
    let buttonDeliberyinfo = document.querySelectorAll(".button_deliberyinfo");
    let buttonCancel = document.querySelectorAll(".button_cancel");
    let buttonBuyconfirm = document.querySelectorAll(".button_buyconfirm");
    let buttonChangeapply = document.querySelectorAll(".button_changeapply");
    let buttonRefundapply = document.querySelectorAll(".button_refundapply");
    let buttonReviewWrite = document.querySelectorAll(".button_reviewwrite");

    buttonDeliberyinfo.forEach((button) => {
      button.addEventListener("click", () => {
        alert("버튼 눌림");
      });
    });

    //버튼 처리 300부분
    buttonCancel.forEach((button) => {
      let orderproduct_id = button.getAttribute("data-orderproduct-id");
      let order_status_cd = button.getAttribute("data-order-status-cd");
      let order_id = button.getAttribute("data-order-id");
      button.addEventListener("click", () => {
        if (confirm("주문 취소를 원하시면 확인을 눌러주세요. ")) {
          console.log(button);
          const data = {
            orderproduct_id: orderproduct_id,
            order_status_cd: 300,
            order_id: order_id,
          };
          console.log(data);
          sendServerData(
            "POST",
            "update",
            "application/json",
            JSON.stringify(data),
            function (data) {
              //data = JSON.parse(data);
              if ((data.status = "OK")) {
                //
                alert("주문 취소 처리 되었습니다.");
                location.reload();
              } else {
                alert("삭제하지 못했습니다.");
              }
            }
          );
        }
      });
    });

    //303 배송완료에서 310구매 확정으로 변경
    buttonBuyconfirm.forEach((button) => {
      let orderproduct_id = button.getAttribute("data-orderproduct-id");
      let order_status_cd = button.getAttribute("data-order-status-cd");
      let order_id = button.getAttribute("data-order-id");
      button.addEventListener("click", () => {
        if (confirm("구매확정을 원하시면 확인을 눌러주세요. ")) {
          console.log(button);
          const data = {
            orderproduct_id: orderproduct_id,
            order_status_cd: 310,
            order_id: order_id,
          };
          console.log(data);
          sendServerData(
            "POST",
            "update",
            "application/json",
            JSON.stringify(data),
            function (data) {
              //data = JSON.parse(data);
              if ((data.status = "OK")) {
                //
                alert("구매확정 처리 되었습니다.");
                location.reload();
              } else {
                alert("처리하지 못했습니다.");
              }
            }
          );
        }
      });
    });

    // buttonCancel.forEach((button) => {
    //   let orderproduct_id = button.getAttribute("data-orderproduct_id");
    //   button.addEventListener("click", () => {
    //     const data = {
    //       orderproduct_id: orderproduct_id,
    //     };
    //     sendServerData(
    //       "POST",
    //       "/order/payresult",
    //       "application/json",
    //       JSON.stringify(data),
    //       function (data) {
    //         data = JSON.parse(data);
    //         if ((data.status = "OK")) {
    //           if (confirm("주문 취소를 원하시면 취소를 눌러주세요. ")) {
    //             alert("주문 취소 처리 되었습니다.");
    //             location.reload();
    //           } else {
    //             alert("삭제하지 못했습니다.");
    //           }
    //         }
    //       }
    //     );
    //   });
    // });
  </script>
</html>
