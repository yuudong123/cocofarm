<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{fragments/head :: headFragment}"></th:block>
    <link rel="stylesheet" href="/css/product/cart.css" />
  </head>
  <body>
    <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
    <main>
      <div class="container">
        <div class="checkbox1">
          <label>
            <input
              type="checkbox"
              class="filled-in"
              name="all"
              id="selectAll"
            />
            <span>전체 상품 선택하기</span>
          </label>
        </div>
        <div><a id="btnDeleteAll">전체 삭제</a></div>
        <section id="section1" class="z-depth-1">
          <form id="orderForm">
            <table id="cartListAll" class="highlight">
              <tbody>
                <tr
                  th:each="cart: ${list}"
                  th:id="'cartItem-' + ${cart.cart_id}"
                >
                  <td>
                    <label>
                      <input
                        type="checkbox"
                        class="filled-in partSelect"
                        name="cart"
                        th:value="${cart.cart_id}"
                        th:data-cartPrice="${cart.amount*cart.product_price}"
                      />
                      <span></span>
                    </label>
                  </td>
                  <td>
                    <img
                      th:src="'/images/'+${cart.product_image}"
                      style="width: 200px"
                    />
                  </td>
                  <td th:text="${cart.product_name}"></td>
                  <td>상품금액</td>
                  <td th:text="${cart.product_price}" id="productPrice"></td>
                  <td>주문개수 :</td>
                  <td th:text="${cart.amount}" id="amount"></td>
                  <td>
                    <a
                      class="btnDelete"
                      th:onclick="onDelete([[${cart.cart_id}]])"
                      >삭제</a
                    >
                  </td>
                  <td>주문금액</td>
                  <td
                    th:with="totalPrice=${cart.amount*cart.product_price}"
                    class="onePayPrice"
                  >
                    <span th:text="${totalPrice}"></span>
                  </td>
                </tr>
              </tbody>
            </table>
          </form>
        </section>
        <section id="section2" class="z-depth-1">
          <table id="orderpalce" class="order">
            <td>총상품금액</td>
            <td id="allPrice">0</td>
            <td><button id="btnAllPayment">총 주문하기</button></td>
          </table>
        </section>
      </div>
    </main>
    <th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>
    <script src="/js/cocofarm.js"></script>
  </body>

  <script>
    const productName = document.querySelector(".productName");
    const productPrice = document.querySelector("#productPrice");
    const amount = document.querySelector("#amount");
    const onePayPrice = document.querySelector(".onePayPrice");
    const btnAllPayment = document.querySelector("#btnAllPayment");
    const orderForm = document.querySelector("#orderForm");
    const partSelect = document.querySelectorAll(".partSelect");
    const allPriceDiv = document.querySelector("#allPrice");
    const allCheckbox = document.querySelector("#selectAll");
    let allPrice = 0;

    btnAllPayment.addEventListener("click", () => {
      orderForm.action = "/order/cartorderpage";
      orderForm.method = "POST";
      orderForm.submit();
    });

    function onDelete(cart_id) {
      const data = {
        cart_id: cart_id,
      };
      sendServerData(
        "POST",
        "/cart/delete",
        "application/json",
        JSON.stringify(data),
        function (data) {
          if (Number(data) > 0) {
            alert("삭제 되었습니다.");
            window.location.reload(true);
          } else {
            alert("삭제하지 못했습니다.");
          }
        }
      );
    }

    [].forEach.call(partSelect, function (part) {
      part.addEventListener("change", checkboxSelect, false);
    });

    function checkboxSelect(e) {
      console.log(e.target);
      var check = e.target;
      console.log(check.checked);

      let cartPrice = Number(check.getAttribute("data-cartPrice"));
      if (check.checked) {
        allPrice = allPrice + cartPrice;
        console.log(allPriceDiv);

        allPriceDiv.textContent = allPrice;
      } else {
        allPrice = allPrice - cartPrice;
        allPriceDiv.textContent = allPrice;
      }
      allCheck();
    }

    // 전체 선택 체크박스

    // // 개별 선택 체크박스들
    // const checkboxes = document.querySelectorAll("#selectOne");

    // 전체 선택 체크박스 클릭 이벤트 처리

    allCheckbox.addEventListener("change", function (e) {
      const isChecked = allCheckbox.checked;
      var check = e.target;
      if (check.checked) {
        allPrice = 0;
        partSelect.forEach(function (checkbox) {
          let cartPrice = Number(checkbox.getAttribute("data-cartPrice"));
          checkbox.checked = isChecked;
          allPrice = allPrice + cartPrice;
          console.log(allPriceDiv);
        });

        allPriceDiv.textContent = allPrice;
      } else {
        partSelect.forEach(function (checkbox) {
          let cartPrice = Number(checkbox.getAttribute("data-cartPrice"));
          checkbox.checked = false;
          console.log(allPriceDiv);
        });
        allPrice = 0;
        allPriceDiv.textContent = 0;
      }
      // 개별 선택 체크박스들 상태 업데이트
    });

    function allCheck() {
      var ok = true;
      partSelect.forEach(function (checkbox) {
        if (checkbox.checked == false) {
          ok = false;
          allCheckbox.checked = false;
          return false;
        }
      });
      if (ok) allCheckbox.checked = true;
    }

    // 개별 선택 체크박스들 클릭 이벤트 처리
    // partSelect.forEach(function (checkbox) {
    // checkbox.addEventListener("click", function () {
    //      const allChecked = Array.from(checkboxes).every(function (checkbox) {
    //        return checkbox.checked;
    //      });
    //     // 전체 선택 체크박스 상태 업데이트
    //     allCheckbox.checked = allChecked;
    //   });
    // });

    document
      .querySelector("#btnDeleteAll")
      .addEventListener("click", function () {
        if (confirm("전체 삭제를 하시려면 확인을 눌러주세요.")) {
          deleteCartList();
        }
      });

    function deleteCartList(member_no) {
      const data = {
        member_no: member_no,
      };
      sendServerData(
        "POST",
        "/cart/alldelete",
        "application/json",
        JSON.stringify(data),
        function (data) {
          if (Number(data) > 0) {
            alert("삭제 되었습니다. ");
            window.location.reload(true);
          } else {
            alert("삭제하지 못했습니다.");
          }
        }
      );
    }
  </script>
</html>
